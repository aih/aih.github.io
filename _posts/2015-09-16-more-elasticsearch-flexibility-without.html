---
layout: post
title: 'More Elasticsearch: Flexibility without duplicates'
date: '2015-09-16T14:27:00.000-07:00'
author: Ari Hershowitz
tags:
- search
- mapping
- analysis
- legal documents
- Elasticsearch
- deduplicate
- indexing
- SQL Server
modified_time: '2015-09-16T14:27:12.612-07:00'
blogger_id: tag:blogger.com,1999:blog-7029518648320057552.post-7138583656215930025
blogger_orig_url: https://blog.linkedlegislation.com/2015/09/more-elasticsearch-flexibility-without.html
---

People want everything. When they're searching, they want flexibility and they want precision, too. Legal researchers, especially, show this cognitive dissonance: in their personal lives they are used to Google's flexibility ("show me that hairy dog that looks like a mop"), and at work they use 'Advanced' search interfaces that can find the right legal document, if only they write a search query that is sufficiently complex ("show me the rule between September 1981-1983 that has the words 'excessive' and 'sanctions' within 4 words of each other, and does not have the word 'contraband'").<br /><br />To search through legal documents, precision is important:&nbsp;42 U.S.C 2000e-5 (a section of the United States Code) is not the same as 42 U.S.C. 2000e. At the same time, a text search for 'discriminate', should probably also return results that have the word 'discrimination'. To handle this in Elasticsearch (ES) seemed at first simple: create two indexes, or two 'types' within a single index. In essence, we'd index the documents once with a permissive analyzer that doesn't discriminate between 'discriminate' and 'discrimination' (an English-language analyzer) and once with a strict analyzer, that breaks words on whitespace and will only match exact terms (read more on ES analyzers&nbsp;<a href="https://www.elastic.co/guide/en/elasticsearch/reference/1.4/analysis-analyzers.html">here</a>). Search the first index when you want a flexible match and the second one when you want an exact match. So far so good.<br /><h3>None or too many</h3><br />But what about combining a flexible match with a strict one ("section 2000e-5" AND discriminate)? You either get no results or duplicates. No results are returned if you're looking for the overlap of the two terms: by design, the two indexes were created separately. &nbsp;OTOH, if you're looking for matches of either term, you get duplicates, one from each index. Back to the drawing board.<br /><br />To remove duplicates, <a href="https://stackoverflow.com/questions/25448186/remove-duplicate-documents-from-a-search-in-elasticsearch">the internet suggests</a>&nbsp;<a href="https://www.elastic.co/guide/en/elasticsearch/guide/current/top-hits.html">field collapsing</a>:&nbsp;index each document, using the same ID value in both indexes, group by ID and set 'top_hits' to 1, to get just one of the two duplicates. Unfortunately, grouping also breaks the nice results pagination that comes with ES. So you can de-duplicate results, but can't easily paginate them. This is a problem for searches that return hundreds, or thousands of results. For a nice afternoon detour, you can <a href="https://github.com/elastic/elasticsearch/issues/4915">read why pagination and aggregation don't play well together</a>.<br /><h3>Two fields in one index</h3><div>O.K., then, how about indexing each field twice within the same document in the index. The two copies should have different names and should be analyzed differently. For example, one could be called 'flex_docText' and the other 'exact_docText'. Combined flexible and exact searches will point to the same document. And while each field is indexed and searched differently, the original text that ES stores will be the same, so we only need to return one of these fields (it doesn't matter which) to the user.</div><div><br /></div><h3>How-to</h3><div>The first step is to create the new index with a 'mapping' for the two fields that defines the different analyzers to use for each:&nbsp; <br /><pre>POST myindex<br />{"mappings":{<br />    "mytype" : {<br />          "properties" : {<br />                "flex_docText" : { "type": "string",<br />          "analyzer" : "english" },<br />                "exact_docText" : { "type": "string",<br />          "analyzer" : "whitespace" }<br />          }<br />    }<br />  }<br />};<br /></pre><pre>https://gist.github.com/aih/79155bd4835d3781b380</pre><pre><br /></pre><pre><span style="font-family: Times; white-space: normal;">Next, index the documents, making sure to index the 'docText' field twice, once under each name. This can be as easy as including the content twice when creating the document:</span></pre><pre><span style="font-family: Times; white-space: normal;"><br /></span></pre><pre><span class="pln" style="border: 0px; box-sizing: border-box; font-family: Consolas, Menlo, 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Lucida Console'; font-size: 16.2000007629395px; font-stretch: inherit; line-height: 24.3000011444092px; margin: 0px; padding: 0px; vertical-align: baseline;">PUT </span><span class="pun" style="border: 0px; box-sizing: border-box; color: #666600; font-family: Consolas, Menlo, 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Lucida Console'; font-size: 16.2000007629395px; font-stretch: inherit; line-height: 24.3000011444092px; margin: 0px; padding: 0px; vertical-align: baseline;">/</span><span class="pun" style="border: 0px; box-sizing: border-box; font-family: Consolas, Menlo, 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Lucida Console'; font-size: 16.2000007629395px; font-stretch: inherit; line-height: 24.3000011444092px; margin: 0px; padding: 0px; vertical-align: baseline;">myindex</span><span class="pun" style="border: 0px; box-sizing: border-box; color: #666600; font-family: Consolas, Menlo, 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Lucida Console'; font-size: 16.2000007629395px; font-stretch: inherit; line-height: 24.3000011444092px; margin: 0px; padding: 0px; vertical-align: baseline;">/</span><span class="pun" style="border: 0px; box-sizing: border-box; font-family: Consolas, Menlo, 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Lucida Console'; font-size: 16.2000007629395px; font-stretch: inherit; line-height: 24.3000011444092px; margin: 0px; padding: 0px; vertical-align: baseline;">mytype</span><span class="pln" style="border: 0px; box-sizing: border-box; font-family: Consolas, Menlo, 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Lucida Console'; font-size: 16.2000007629395px; font-stretch: inherit; line-height: 24.3000011444092px; margin: 0px; padding: 0px; vertical-align: baseline;"><br /></span><span class="pun" style="border: 0px; box-sizing: border-box; color: #666600; font-family: Consolas, Menlo, 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Lucida Console'; font-size: 16.2000007629395px; font-stretch: inherit; line-height: 24.3000011444092px; margin: 0px; padding: 0px; vertical-align: baseline;">{</span><span class="pln" style="border: 0px; box-sizing: border-box; font-family: Consolas, Menlo, 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Lucida Console'; font-size: 16.2000007629395px; font-stretch: inherit; line-height: 24.3000011444092px; margin: 0px; padding: 0px; vertical-align: baseline;"><br />  </span><span class="str" style="border: 0px; box-sizing: border-box; color: #008800; font-family: Consolas, Menlo, 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Lucida Console'; font-size: 16.2000007629395px; font-stretch: inherit; line-height: 24.3000011444092px; margin: 0px; padding: 0px; vertical-align: baseline;">"flex_docText"</span><span class="pun" style="border: 0px; box-sizing: border-box; color: #666600; font-family: Consolas, Menlo, 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Lucida Console'; font-size: 16.2000007629395px; font-stretch: inherit; line-height: 24.3000011444092px; margin: 0px; padding: 0px; vertical-align: baseline;">:</span><span class="pln" style="border: 0px; box-sizing: border-box; font-family: Consolas, Menlo, 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Lucida Console'; font-size: 16.2000007629395px; font-stretch: inherit; line-height: 24.3000011444092px; margin: 0px; padding: 0px; vertical-align: baseline;"> </span><span class="str" style="border: 0px; box-sizing: border-box; color: #008800; font-family: Consolas, Menlo, 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Lucida Console'; font-size: 16.2000007629395px; font-stretch: inherit; line-height: 24.3000011444092px; margin: 0px; padding: 0px; vertical-align: baseline;">"This is the text to be indexed."</span><span class="pun" style="border: 0px; box-sizing: border-box; color: #666600; font-family: Consolas, Menlo, 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Lucida Console'; font-size: 16.2000007629395px; font-stretch: inherit; line-height: 24.3000011444092px; margin: 0px; padding: 0px; vertical-align: baseline;">,</span><span class="pln" style="border: 0px; box-sizing: border-box; font-family: Consolas, Menlo, 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Lucida Console'; font-size: 16.2000007629395px; font-stretch: inherit; line-height: 24.3000011444092px; margin: 0px; padding: 0px; vertical-align: baseline;"><br />  </span><span class="str" style="border: 0px; box-sizing: border-box; color: #008800; font-family: Consolas, Menlo, 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Lucida Console'; font-size: 16.2000007629395px; font-stretch: inherit; line-height: 24.3000011444092px; margin: 0px; padding: 0px; vertical-align: baseline;">"exact_docText"</span><span class="pun" style="border: 0px; box-sizing: border-box; color: #666600; font-family: Consolas, Menlo, 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Lucida Console'; font-size: 16.2000007629395px; font-stretch: inherit; line-height: 24.3000011444092px; margin: 0px; padding: 0px; vertical-align: baseline;">:</span><span class="pln" style="border: 0px; box-sizing: border-box; font-family: Consolas, Menlo, 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Lucida Console'; font-size: 16.2000007629395px; font-stretch: inherit; line-height: 24.3000011444092px; margin: 0px; padding: 0px; vertical-align: baseline;">  </span><span class="str" style="border: 0px; box-sizing: border-box; color: #008800; font-family: Consolas, Menlo, 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Lucida Console'; font-size: 16.2000007629395px; font-stretch: inherit; line-height: 24.3000011444092px; margin: 0px; padding: 0px; vertical-align: baseline;">"This is the text to be indexed."</span><span class="pln" style="border: 0px; box-sizing: border-box; font-family: Consolas, Menlo, 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Lucida Console'; font-size: 16.2000007629395px; font-stretch: inherit; line-height: 24.3000011444092px; margin: 0px; padding: 0px; vertical-align: baseline;"><br /></span><span class="pun" style="border: 0px; box-sizing: border-box; color: #666600; font-family: Consolas, Menlo, 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Lucida Console'; font-size: 16.2000007629395px; font-stretch: inherit; line-height: 24.3000011444092px; margin: 0px; padding: 0px; vertical-align: baseline;">}</span></pre></div><div><br /></div><div><h3>Indexing from SQL</h3></div><div><pre><span style="font-family: Times; white-space: normal;">An additional complication arises when importing data from a SQL database. As described in <a href="https://blog.tabulaw.com/2015/08/elasticsearch-and-ms-sql-server-would.html">my earlier post</a>, a nice open source&nbsp;<a href="https://github.com/jprante/elasticsearch-jdbc">JDBC import tool</a> was built for this purpose. So nice, in fact, that it directly takes the output of a SQL query and sends it to Elasticsearch to be indexed. The downside is that the data is indexed with just the name it has in the SQL query. &nbsp;So, if your database column is named 'docText', in a table named 'myTable', you might use this query:</span></pre><pre><span style="font-family: Times; white-space: normal;"><br /></span></pre><pre><span style="font-family: Times; white-space: normal;">SELECT <i>docText</i> FROM <i>myTable</i></span></pre><pre><span style="font-family: Times; white-space: normal;"><i><br /></i></span></pre><pre><span style="font-family: Times;"><span style="white-space: normal;">The JDBC import tool would then index one field, called <i>docText</i>. If you want to create two parallel fields in the index, it is necessary to <b>rename</b>&nbsp;the database column, and extract it twice from the database, using the following syntax:</span></span></pre><pre><span style="font-family: Times;"><span style="white-space: normal;"><br /></span></span></pre><pre><span style="font-family: Times; white-space: normal;">SELECT&nbsp;<i>docText</i>&nbsp;as <i>flex_docText, docText</i>&nbsp;as <i>exact_docText&nbsp;</i>FROM&nbsp;<i>myTable</i></span></pre><pre><span style="font-family: Times; white-space: normal;"><i><br /></i></span></pre><pre><span style="font-family: Times; white-space: normal;">In fact, you can extract the same data as many times as you want, under different names, and apply different analysis to the data in the index mapping. &nbsp;Does that really work? Yes, that really works. &nbsp;Now if you want to highlight search results and avoid duplicates, that's a story for another day.</span></pre></div>