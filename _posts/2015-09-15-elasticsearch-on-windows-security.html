---
layout: post
title: 'Elasticsearch on Windows: Security'
date: '2015-09-15T14:17:00.001-07:00'
author: Ari Hershowitz
tags:
- security
- Elasticsearch
- GSA
- Windows
- 18F
- Department of Labor
- reverse proxy
- IIS
modified_time: '2015-09-15T22:38:07.969-07:00'
blogger_id: tag:blogger.com,1999:blog-7029518648320057552.post-2867011519292878561
blogger_orig_url: https://blog.linkedlegislation.com/2015/09/elasticsearch-on-windows-security.html
---

A government client wants to be able to search through their data. In a typical case, an office or agency has a long-standing rulebook that employees still carry around in a paper binder, because they lack a browsable, searchable electronic version. For example, the <a href="https://18f.gsa.gov/">GSA's consulting group, 18F</a> recently described how they helped the Department of Labor <a href="https://18f.gsa.gov/2015/09/09/how-a-two-day-spring-moved-an-agency-twenty-years-forward/">envision and design an electronic version</a> of the Field Operations Handbook. Their prototype included a search layer built on Elasticsearch and served withApache (presumably on a Linux server). <br /><br />In almost any nook and cranny of government, you will find similar handbooks, guidebooks, rulebooks and other books that are crying out for user-friendly search layer. Elasticsearch is an excellent choice for such a project, but it often needs to be integrated with the government's (usually Windows-based) servers. Kudos to 18F for introducing Linux in many of their projects, but for now, those projects are the exception. For the rest of us, using Elasticsearch on Windows presents a number of challenges. All of these can be overcome, though documentation for these solutions is scarce.<br /><br />In my last post, I described how data from a MS SQL Server can be imported to and indexed in Elasticsearch. In future posts, I will discuss some indexing and analysis tricks that can make the search experience smoother (like how to avoid retrieving duplicate results). This post is dedicated to security of the Elasticsearch cluster on Windows.<br /><br /><h3>Elasticsearch lacks built-in security</h3>Out of the box, Elasticsearch:<br /><ol><li>&nbsp;Uses a separate port (default = :9200) for requests and responses. Searching directly from the browser would require opening the port to web traffic on the server.</li><li>Allows data to be changed and deleted, in addition to being retrieved. This is great for a developer who can quickly create, delete and update a search index. You don't usually want your users to have these superpowers, though.</li><li>Provides data about the entire search cluster and all indexes on the cluster. That's like having a SQL server open to the world. While this may please <a href="https://xkcd.com/327/">Bobby Tables</a>, it makes the rest of us uncomfortable.</li></ol>Elasticsearch&nbsp;<a href="https://www.elastic.co/blog/found-elasticsearch-security">is not built</a>&nbsp;with integrated security features. You can use a separate plugin, called 'Shield', for security, though that introduces another dependency and may be overkill for many use cases. It is also possible to route all traffic to Elasticsearch through your server-side web application, but this requires a lot of duplicate logic to accept and return requests.<br /><br />Another option is to use features of the IIS webserver itself. For this, you will have to build a search application interface, but for any practical search project you will want to do that anyway. I have stripped down <a href="https://github.com/jettro/elasticsearch-gui">one such GUI</a>&nbsp;to focus on text-base document searches. <a href="https://github.com/aih/elasticsearch-gui">This starter application</a>&nbsp;(on Github) takes user input,&nbsp;formulates searches and returns a paginated list of results. Do let me know if you use it: I have discovered many useful improvements to satisfy specific client needs.<br /><br /><h3>Using a Reverse Proxy on IIS</h3>With IIS serving your main application, you can&nbsp;<a href="https://blogs.iis.net/owscott/creating-a-reverse-proxy-with-url-rewrite-for-iis">create a reverse proxy on IIS</a>&nbsp;for Elasticsearch requests. The reverse proxy will&nbsp;translate and reroute url web requests&nbsp;into internal requests to Elasticsearch.&nbsp;How does this work? Your application requests to <i>https://www.mydomain.com/search</i>&nbsp;are routed by IIS internally to https:localhost:9200/_search. The internal address is not accessible to outside web traffic.<br /><br />Advantages:<br /><ol><li>No need to expose another port. All traffic can be routed through a url on your default web port (:80).</li><li>Block delete and change requests-- simply don't set up any urls that will route these requests to Elasticsearch.</li><li>Use IIS security features as needed for your main application (e.g. Anonymous login or Windows login).</li></ol>On IIS, setting up a reverse proxy is not as tough as it sounds. It requires two modules that can be installed using the Web Platform Installer: URLRewrite and ARR. Thorough instructions for setting up the reverse proxy&nbsp;<a href="https://www.wrapcode.com/infrastructure/configure-reverse-proxy-with-url-rewrite-and-arr-for-iis/">can be found here</a>. The essentials (and ES-specific details) follow:<br /><br /><h4>Install Web Platform Installer</h4><div>Pretty straightforward, from a <a href="https://www.microsoft.com/web/downloads/platform.aspx">Microsoft downloads page</a>.<br /><br /><h4>Install ARR and URLRewrite modules</h4>Open the Web Platform Installer interface, search for "ARR" and "URLRewrite" respectively, and follow instructions to install each of them.<br /><br /></div><div><h4>Create the URLRewrite rules for your website</h4></div><div><ol><li><a href="https://technet.microsoft.com/en-us/library/cc770472(v=ws.10).aspx">Open the IIS Server Manager</a>&nbsp;and navigate to your website in the <b>Connections</b>&nbsp;column on the left side. Double click on the Application Request Routing Cache icon (ARR, under IIS, in the Features View).&nbsp;</li><li>Open <b>Server Proxy Settings</b>&nbsp;on the right side of ARR and make sure the checkbox is selected for&nbsp;<b>Enable Proxy</b>. Close the ARR menu. Double click on the &nbsp;URLRewrite icon. Click Add Rule -&gt; Blank Rule.</li><li>Write the rewrite rules for Elasticsearch. The main rewrite rule will &nbsp;use Regular Expressions to match the a pattern like: <i>search/_search(.*)</i>, and rewrite it as&nbsp;<i>https://localhost:9200/_search{R:1}</i></li><li>You may want to expose other Elasticsearch API's as well, and it is best to create a rewrite URL for each of them. For example, to check the health of the cluster, match&nbsp;<i>search/_cluster/health </i>to&nbsp;<i>https://localhost:9200/_cluster/health. </i>If you are having trouble writing using the IIS Manager UI to enter these rules, consult the&nbsp;&nbsp;<a href="https://www.wrapcode.com/infrastructure/configure-reverse-proxy-with-url-rewrite-and-arr-for-iis/">blog I referred to earlier</a>, or directly add the rules to your web.config file.</li><li>When you are done entering the rewrite rules, you will have an XML file in your website folder called web.config that will include a &lt;rewrite&gt; section. &nbsp;It should look something like this file:&nbsp;https://gist.github.com/aih/8f2b8d76b44d8836bd77</li></ol><h4>Test it out</h4><h4></h4></div><div>From your application, you should now be able to submit a query (either as query parameters in the url, or with a json query payload) to https://[www.yoursite.com]/search, and get the response from Elasticsearch. Note that now the path at&nbsp;<i>/search</i>&nbsp;is reserved for Elasticsearch traffic, so your application cannot use that path (e.g. for a webpage). &nbsp;If this is a problem, you can use any path you prefer for your reverse proxy settings.<br /><br /></div><div><h4>Your thoughts?</h4></div><div>The Elastic team described setting up a&nbsp;<a href="https://www.elastic.co/blog/playing-http-tricks-nginx">reverse proxy with Nginx</a>&nbsp;for many of the same reasons, and this does seem like a clean way to expose only the search API to external web traffic. Are there other architectures you have used for Elasticsearch on Windows? Do you see security vulnerabilities with the approach I've descriped? I'd like to hear your thoughts in the comments.</div>